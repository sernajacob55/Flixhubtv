<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Browse • FlixHubTV</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Header / Navbar -->
  <header>
    <h1><span class="flix">FLIX</span><span class="hub">HubTV</span></h1>

    <div class="nav-buttons">
      <button id="menuToggle">☰</button>
      <input id="searchInput" type="text" placeholder="Search movies..." aria-label="Search movies"/>
      <button id="switchProfileBtn" onclick="location.href='profiles.html'">Switch Profile</button>
      <button id="logoutBtn" onclick="location.href='login.html'">Logout</button>
      <button id="homeBtn" onclick="location.href='index.html'">Home</button>
    </div>
  </header>

  <!-- Page wrapper -->
  <div class="page">
    <!-- Sidebar -->
    <aside class="sidebar" id="leftSidebar" aria-label="Genres">
      <h3>Genres</h3>
      <ul></ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="content">
      <div class="welcome" id="welcomeText">Welcome, Serna</div>

      <!-- Continue Watching -->
      <section class="continue-watching">
        <h2>Continue Watching</h2>
        <div id="continueWatchingList" class="movie-grid"></div>
      </section>

      <!-- Watchlist -->
      <section class="watchlist">
        <h2>My Watchlist</h2>
        <div id="watchlistGrid"></div>
      </section>

      <!-- Banner Above Movie Grid -->
      <div class="movies-banner">Movies</div>

      <!-- Movie Grid (auto-populated) -->
      <section class="movie-grid" id="movieGrid"></section>
    </main>
  </div>

  <!-- Footer -->
  <footer>
    <p>© 2025 FlixHubTV. All rights reserved.</p>
  </footer>

  <!-- ✅ Shared Fullscreen Player -->
  <div id="videoPlayer" class="video-player" style="display:none;">
    <button id="exitFullscreen" class="close-btn">X</button>
    <video id="movieVideo" controls autoplay></video>
  </div>

  <!-- ✅ Scripts -->
  <script src="movies.js"></script>
  <script src="player.js"></script>

  <script>
    const OMDB_KEY = "ea7569d7";

    // Sidebar Toggle
    document.getElementById("menuToggle").addEventListener("click", () => {
      document.body.classList.toggle("sidebar-open");
    });

    // Load movie list from movies.js
    async function loadMovies() {
      try {
        const movieMap = window.movieMap;
        if (!movieMap || typeof movieMap !== "object") {
          console.error("movies.js not loaded or movieMap missing.");
          return;
        }

        const grid = document.getElementById("movieGrid");

        for (const imdbID of Object.keys(movieMap)) {
          const omdbRes = await fetch(`https://www.omdbapi.com/?i=${imdbID}&apikey=${OMDB_KEY}`);
          const data = await omdbRes.json();

          const title = data.Title || "Unknown";
          const poster = (data.Poster && data.Poster !== "N/A") ? data.Poster : "placeholder.jpg";
          const genres = data.Genre || "";

          const wrapper = document.createElement("div");
          wrapper.className = "movie-card-wrapper";
          wrapper.innerHTML = `
            <div class="movie-card" data-id="${imdbID}" data-genres="${genres}" onclick="location.href='movie.html?id=${imdbID}'">
              <img src="${poster}" alt="${title} poster" />
              <h3>${title}</h3>
            </div>
            <button class="action-btn watchlist-toggle" data-id="${imdbID}">+ Add to Watchlist</button>
          `;
          grid.appendChild(wrapper);
        }

        setupSearch();
        setupSidebar();
        setupWatchlist();
        setupContinueWatching();
      } catch (err) {
        console.error("Error loading movies.js:", err);
      }
    }

    // Live Search
    function setupSearch() {
      const searchInput = document.getElementById("searchInput");
      const cards = document.querySelectorAll(".movie-card");
      if (!searchInput) return;
      searchInput.addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase();
        cards.forEach(card => {
          const title = card.querySelector("h3").textContent.toLowerCase();
          card.style.display = title.includes(query) ? "" : "none";
        });
      });
    }

    // Auto-Populate Genres Sidebar
    function setupSidebar() {
      const sidebar = document.getElementById("leftSidebar");
      const genreList = sidebar.querySelector("ul");
      const cards = document.querySelectorAll(".movie-card");
      let genres = new Set();

      cards.forEach(card => {
        const g = (card.getAttribute("data-genres") || "").split(",");
        g.forEach(x => { if (x.trim()) genres.add(x.trim()); });
      });

      genreList.innerHTML = `<li data-filter="all">All</li>`;
      genres.forEach(g => {
        const li = document.createElement("li");
        li.textContent = g;
        li.setAttribute("data-filter", g);
        genreList.appendChild(li);
      });

      genreList.addEventListener("click", (e) => {
        const li = e.target.closest("li");
        if (!li) return;
        const filter = li.getAttribute("data-filter");
        cards.forEach(card => {
          const cardGenres = (card.getAttribute("data-genres") || "").split(",");
          card.style.display = (filter === "all" || cardGenres.includes(filter)) ? "" : "none";
        });
      });
    }

    // Watchlist Toggle
    function setupWatchlist() {
      const buttons = document.querySelectorAll('.watchlist-toggle');
      let watchlist = JSON.parse(localStorage.getItem("watchlist")) || [];

      function updateButton(btn) {
        const id = btn.getAttribute("data-id");
        btn.textContent = watchlist.includes(id) ? "✓ Added" : "+ Add to Watchlist";
      }

      buttons.forEach(btn => {
        updateButton(btn);
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = btn.getAttribute("data-id");
          if (watchlist.includes(id)) {
            watchlist = watchlist.filter(x => x !== id);
          } else {
            watchlist.push(id);
          }
          localStorage.setItem("watchlist", JSON.stringify(watchlist));
          updateButton(btn);
          renderWatchlist();
        });
      });

      renderWatchlist();

      function renderWatchlist() {
        const grid = document.getElementById("watchlistGrid");
        const section = document.querySelector(".watchlist");
        grid.innerHTML = "";

        watchlist.forEach(id => {
          const card = document.querySelector(`.movie-card[data-id="${id}"]`);
          if (card) {
            const img = card.querySelector("img").src;
            const title = card.querySelector("h3").textContent;
            const div = document.createElement("div");
            div.className = "watchlist-item";
            div.innerHTML = `
              <img src="${img}" alt="Poster for ${title}" />
              <button class="remove-btn" data-id="${id}">X</button>
            `;
            grid.appendChild(div);
          }
        });

        // Attach remove button listeners for Watchlist
        grid.querySelectorAll(".remove-btn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const id = btn.getAttribute("data-id");
            watchlist = watchlist.filter(x => x !== id);
            localStorage.setItem("watchlist", JSON.stringify(watchlist));
            renderWatchlist();
            // Update main grid button state too
            document.querySelectorAll(`.watchlist-toggle[data-id="${id}"]`).forEach(b => {
              b.textContent = "+ Add to Watchlist";
            });
          });
        });

        section.style.display = grid.children.length > 0 ? "block" : "none";
      }
    }

    // ✅ Continue Watching with remove button
    function setupContinueWatching() {
      const list = document.getElementById("continueWatchingList");
      const section = document.querySelector(".continue-watching");
      let continued = [];
      try { 
        continued = JSON.parse(localStorage.getItem("continueWatching")) || []; 
      } catch (e) { 
        continued = []; 
      }
      if (!Array.isArray(continued)) continued = [];

      list.innerHTML = "";

      continued.forEach(item => {
        if (!item || typeof item !== "object") return;
        const { poster, title, imdbID } = item;
        if (!poster || !title || !imdbID) return;

        const div = document.createElement("div");
        div.className = "movie-card";
        div.dataset.id = imdbID;
        div.innerHTML = `
          <a href="movie.html?id=${imdbID}">
            <img src="${poster}" alt="Poster for ${title}" />
            <h3>${title}</h3>
          </a>
          <button class="remove-btn" data-id="${imdbID}">X</button>
        `;
        list.appendChild(div);
      });

      // Attach remove button listeners
      list.querySelectorAll(".remove-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = btn.getAttribute("data-id");
          let continued = JSON.parse(localStorage.getItem("continueWatching")) || [];
          continued = continued.filter(m => m.imdbID !== id);
          localStorage.setItem("continueWatching", JSON.stringify(continued));
          setupContinueWatching();
        });
      });

      section.style.display = list.children.length > 0 ? "block" : "none";
    }

    // ✅ Auto-refresh Continue Watching on storage changes
    window.addEventListener("storage", () => {
      setupContinueWatching();
    });

    // Init
    loadMovies();
  </script>
</body>
</html>