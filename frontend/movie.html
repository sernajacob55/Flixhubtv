<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie - FlixHubTV</title>
  <link rel="stylesheet" href="style.css">
  <script src="player.js" defer></script>
  <script>
    const omdbKey = "ea7569d7";   // your OMDb key
    const tmdbKey = "a2942c822ee97bc0df2dba1a65cf2d0f"; // your TMDb key

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const movieId = urlParams.get("id");

      const movieTitle = document.getElementById("movieTitle");
      const moviePoster = document.getElementById("moviePoster");
      const moviePlot = document.getElementById("moviePlot");
      const movieMeta = document.getElementById("movieMeta");
      const castContainer = document.getElementById("cast");
      const recContainer = document.getElementById("recommended");
      const videoElement = document.getElementById("videoElement");

      if (movieId) {
        // 1. Fetch OMDb movie details
        fetch(`https://www.omdbapi.com/?i=${movieId}&apikey=${omdbKey}`)
          .then(res => res.json())
          .then(data => {
            if (data.Response === "True") {
              movieTitle.textContent = data.Title;
              moviePoster.src = data.Poster;
              moviePlot.textContent = data.Plot;
              movieMeta.textContent = `Year: ${data.Year} | Runtime: ${data.Runtime} | Genre: ${data.Genre}`;

              // 2. Load MediaFire link from metadata.json
              fetch("movie-metadata.json")
                .then(res => res.json())
                .then(meta => {
                  if (meta[movieId] && meta[movieId].link) {
                    videoElement.src = meta[movieId].link;
                  }
                });

              // 3. Cast (split actors & fetch pictures from TMDb)
              const actors = data.Actors.split(",").map(a => a.trim());
              actors.forEach(actor => {
                fetch(`https://api.themoviedb.org/3/search/person?api_key=${tmdbKey}&query=${encodeURIComponent(actor)}`)
                  .then(res => res.json())
                  .then(tmdbData => {
                    if (tmdbData.results && tmdbData.results.length > 0) {
                      const person = tmdbData.results[0];
                      const imgUrl = person.profile_path
                        ? `https://image.tmdb.org/t/p/w200${person.profile_path}`
                        : "https://via.placeholder.com/100x150?text=No+Image";
                      const div = document.createElement("div");
                      div.classList.add("actor-card");
                      div.innerHTML = `<img src="${imgUrl}" alt="${actor}"><p>${actor}</p>`;
                      castContainer.appendChild(div);
                    }
                  });
              });

              // 4. Recommended movies (first genre from OMDb)
              const firstGenre = data.Genre.split(",")[0].trim();
              fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(firstGenre)}&apikey=${omdbKey}`)
                .then(res => res.json())
                .then(recData => {
                  if (recData.Search) {
                    recData.Search.slice(0, 5).forEach(movie => {
                      const card = document.createElement("div");
                      card.classList.add("rec-card");
                      card.innerHTML = `
                        <img src="${movie.Poster !== "N/A" ? movie.Poster : "https://via.placeholder.com/150"}" alt="${movie.Title}">
                        <p>${movie.Title}</p>
                      `;
                      card.onclick = () => {
                        window.location.href = `movie.html?id=${movie.imdbID}`;
                      };
                      recContainer.appendChild(card);
                    });
                  }
                });
            } else {
              movieTitle.textContent = "Movie not found";
            }
          })
          .catch(err => {
            console.error("Error fetching movie:", err);
            movieTitle.textContent = "Error loading movie";
          });
      }
    });
  </script>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>FlixHubTV</h1>
    <div class="actions">
      <input type="text" class="search-bar" placeholder="Search movies...">
      <button onclick="window.location.href='profiles.html'">Switch Profile</button>
      <button onclick="window.location.href='login.html'">Logout</button>
      <button onclick="window.location.href='index.html'">Home</button>
    </div>
  </header>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Genres</h2>
    <ul>
      <li><a href="#">All</a></li>
      <li><a href="#">Action</a></li>
      <li><a href="#">Sci-Fi</a></li>
      <li><a href="#">Comedy</a></li>
      <li><a href="#">Drama</a></li>
    </ul>
  </div>

  <!-- Movie Details -->
  <div class="movie-container">
    <h2 id="movieTitle">Loading...</h2>
    <img id="moviePoster" src="" alt="Movie Poster" style="width:200px; border-radius:8px;">
    <p id="movieMeta"></p>
    <p id="moviePlot">Fetching details...</p>

    <button id="playButton" class="btn">▶ Play</button>
    <button id="watchlistButton" class="btn">+ Add to Watchlist</button>
  </div>

  <!-- Cast Section -->
  <section>
    <h2>Cast</h2>
    <div id="cast" class="cast-container"></div>
  </section>

  <!-- Recommended Movies -->
  <section>
    <h2>Recommended</h2>
    <div id="recommended" class="recommended-container"></div>
  </section>

  <!-- Video Player -->
  <div id="videoContainer" class="video-player" style="display:none;">
    <video id="videoElement" controls>
      <source src="" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <button id="closeBtn" class="close-btn">✖</button>
  </div>
</body>
</html>