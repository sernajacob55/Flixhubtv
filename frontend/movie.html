<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Movie Info • FlixHubTV</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Header / Navbar -->
  <header>
    <h1><span class="flix">FLIX</span><span class="hub">HubTV</span></h1>

    <div class="nav-buttons">
      <button id="menuToggle">☰</button>
      <input id="searchInput" type="text" placeholder="Search movies..." aria-label="Search movies"/>
      <button id="homeBtn" onclick="location.href='index.html'">Home</button>
      <button id="switchProfileBtn" onclick="location.href='profiles.html'">Switch Profile</button>
      <button id="logoutBtn" onclick="location.href='login.html'">Logout</button>
    </div>
  </header>

  <!-- Page wrapper -->
  <div class="page">
    <!-- Sidebar -->
    <aside class="sidebar" id="leftSidebar" aria-label="Genres">
      <h3>Genres</h3>
      <ul></ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="content">
      <div class="welcome" id="welcomeText">Welcome, Serna</div>

      <!-- ✅ Movie Info Section -->
      <section id="movieInfo"></section>

      <!-- ✅ Cast Grid Section -->
      <section id="castGrid"></section>

      <!-- ✅ Recommended Movies Section -->
      <section>
        <h2 style="margin-top:40px; color:#00bfff;">Recommended Movies</h2>
        <div id="recommendGrid"></div>
      </section>
    </main>
  </div>

  <!-- Footer -->
  <footer>
    <p>© 2025 FlixHubTV. All rights reserved.</p>
  </footer>

  <!-- ✅ Shared Fullscreen Player -->
  <div id="videoPlayer" class="video-player" style="display:none;">
    <button id="exitFullscreen" class="close-btn">X</button>
    <video id="movieVideo" controls autoplay></video>
  </div>

  <!-- ✅ Scripts -->
  <script src="movies.js"></script>
  <script src="player.js"></script>

  <script>
    const OMDB_KEY = "ea7569d7";

    // Sidebar Toggle
    document.getElementById("menuToggle").addEventListener("click", () => {
      document.body.classList.toggle("sidebar-open");
    });

    // Load selected movie info
    async function loadMovieInfo() {
      const params = new URLSearchParams(window.location.search);
      const imdbID = params.get("id");
      if (!imdbID || !window.movieMap[imdbID]) {
        document.getElementById("movieInfo").innerHTML = "<p>Movie not found.</p>";
        return;
      }

      // ✅ Prefer local metadata if available
      let data = window.movieMeta && window.movieMeta[imdbID] ? window.movieMeta[imdbID] : {};

      // ✅ Fallback to OMDb if missing key fields
      if (!data.plot || !data.director) {
        try {
          const res = await fetch(`https://www.omdbapi.com/?i=${imdbID}&apikey=${OMDB_KEY}`);
          const apiData = await res.json();
          data = { ...apiData, ...data }; // merge OMDb into local
        } catch (err) {
          console.warn("OMDb fetch failed, using local only", err);
        }
      }

      const title = data.title || data.Title || "Unknown Title";
      const year = data.year || data.Year || "";
      const runtime = data.runtime || data.Runtime || "";
      const genre = data.genre || data.Genre || "";
      const plot = data.plot || data.Plot || "Plot not available.";
      const poster = (data.poster && data.poster !== "N/A") ? data.poster : (data.Poster && data.Poster !== "N/A" ? data.Poster : "placeholder.jpg");
      const director = data.director || data.Director || "N/A";
      const writer = data.writer || data.Writer || "N/A";
      const actors = data.actors || data.Actors || "N/A";
      const rated = data.rated || data.Rated || "N/A";
      const awards = data.awards || data.Awards || "N/A";
      const boxOffice = data.boxOffice || data.BoxOffice || "N/A";
      const imdbRating = data.imdbRating || "N/A";
      const imdbVotes = data.imdbVotes || "N/A";

      // ✅ Save current movie context for resume
      localStorage.setItem("currentMovieData", JSON.stringify({ imdbID, title, poster }));

      const infoDiv = document.getElementById("movieInfo");
      infoDiv.innerHTML = `
        <div class="movie-detail">
          <img src="${poster}" alt="Poster for ${title}" class="movie-detail-poster"/>
          <div class="movie-detail-text">
            <h2>${title}</h2>
            <p><strong>Year:</strong> ${year}</p>
            <p><strong>Runtime:</strong> ${runtime}</p>
            <p><strong>Genre:</strong> ${genre}</p>
            <p><strong>Rated:</strong> ${rated}</p>
            <p><strong>Director:</strong> ${director}</p>
            <p><strong>Writer:</strong> ${writer}</p>
            <p><strong>Actors:</strong> ${actors}</p>
            <p><strong>Awards:</strong> ${awards}</p>
            <p><strong>Box Office:</strong> ${boxOffice}</p>
            <p><strong>IMDb Rating:</strong> ${imdbRating} (${imdbVotes} votes)</p>
            <p><strong>Plot:</strong> ${plot}</p>
            <button id="playBtn" class="action-btn">▶ Play</button>
          </div>
        </div>
      `;

      // ✅ Build Cast Grid
      const castDiv = document.getElementById("castGrid");
      castDiv.innerHTML = "";
      if (actors && actors !== "N/A") {
        const actorList = actors.split(",").map(a => a.trim());
        actorList.forEach(actor => {
          castDiv.innerHTML += `
            <div class="actor-card">
              <img src="placeholder.jpg" alt="${actor}"/>
              <p>${actor}</p>
            </div>
          `;
        });
      }

      // ✅ Recommended Movies (use local metadata for speed)
      const recommendDiv = document.getElementById("recommendGrid");
      recommendDiv.innerHTML = "";
      if (genre) {
        const genreKeywords = genre.split(",").map(g => g.trim().toLowerCase());
        for (const [id, meta] of Object.entries(window.movieMeta || {})) {
          if (id !== imdbID && meta.genre) {
            const recGenre = meta.genre.toLowerCase();
            if (genreKeywords.some(g => recGenre.includes(g))) {
              recommendDiv.innerHTML += `
                <div class="movie-card" onclick="location.href='movie.html?id=${id}'">
                  <img src="${meta.poster}" alt="${meta.title}"/>
                  <h3>${meta.title}</h3>
                </div>
              `;
            }
          }
        }
      }

      // ✅ Play button
      document.getElementById("playBtn").addEventListener("click", () => {
        const videoPlayer = document.getElementById("videoPlayer");
        const video = document.getElementById("movieVideo");
        video.src = window.movieMap[imdbID] || "";
        video.load();

        if (video.src) {
          videoPlayer.style.display = "flex";
          video.play().catch(err => console.warn("Playback failed:", err));
        } else {
          alert("Video source not found.");
        }
      });
    }

    // Init
    loadMovieInfo();
  </script>
</body>
</html>