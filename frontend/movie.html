<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Movie • FlixHubTV</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Header -->
  <header>
    <h1><span class="flix">FLIX</span><span class="hub">HubTV</span></h1>
    <div class="nav-buttons">
      <button onclick="location.href='index.html'">Home</button>
      <button onclick="location.href='profiles.html'">Switch Profile</button>
      <button onclick="location.href='login.html'">Logout</button>
    </div>
  </header>

  <!-- Page wrapper -->
  <div class="page">
    <!-- Sidebar -->
    <aside class="sidebar" id="leftSidebar" aria-label="Genres">
      <h3>Genres</h3>
      <ul>
        <li data-filter="all">All</li>
        <li data-filter="Action">Action</li>
        <li data-filter="Sci-Fi">Sci-Fi</li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="movieContent">
      <!-- Movie Metadata -->
      <section id="movieDetails" class="movie-details">
        <img id="moviePoster" alt="Movie Poster"/>
        <div>
          <h2 id="movieTitle"></h2>
          <p><strong>Genre:</strong> <span id="movieGenre"></span></p>
          <p><strong>Runtime:</strong> <span id="movieRuntime"></span></p>
          <p id="moviePlot"></p>

          <button id="watchlistBtn" class="action-btn">+ Add to Watchlist</button>
          <button id="playBtn" class="action-btn">▶ Play</button>
        </div>
      </section>

      <!-- Cast Section -->
      <section id="castSection">
        <h3>Cast</h3>
        <div id="castGrid"></div>
      </section>

      <!-- Recommended Movies -->
      <section id="recommendations">
        <h3>Recommended</h3>
        <div id="recommendGrid"></div>
      </section>
    </main>
  </div>

  <!-- Footer -->
  <footer>
    <p>© 2025 FlixHubTV. All rights reserved.</p>
  </footer>

  <!-- Fullscreen Player -->
  <div id="videoPlayer" class="video-player" style="display:none;">
    <button id="exitFullscreen" class="close-btn">X</button>
    <video id="movieVideo" controls autoplay></video>
  </div>

  <!-- ✅ Load movies.js before main script -->
  <script src="movies.js"></script>

  <script>
    const OMDB_KEY = "ea7569d7"; 
    const TMDB_KEY = "a2942c822ee97bc0df2dba1a65cf2d0f";

    const urlParams = new URLSearchParams(window.location.search);
    const imdbID = urlParams.get("id");

    // Sidebar hover
    const sidebar = document.getElementById('leftSidebar');
    sidebar.addEventListener('mouseenter', () => document.body.classList.add('sidebar-open'));
    sidebar.addEventListener('mouseleave', () => document.body.classList.remove('sidebar-open'));

    // Load metadata
    async function loadMovieDetails() {
      try {
        const res = await fetch(`https://www.omdbapi.com/?i=${imdbID}&apikey=${OMDB_KEY}`);
        const data = await res.json();
        if (!data || !data.Title) return;
        document.getElementById("moviePoster").src = data.Poster && data.Poster !== "N/A" ? data.Poster : "placeholder.jpg";
        document.getElementById("movieTitle").textContent = `${data.Title} (${data.Year || "N/A"})`;
        document.getElementById("movieGenre").textContent = data.Genre || "N/A";
        document.getElementById("movieRuntime").textContent = data.Runtime || "N/A";
        document.getElementById("moviePlot").textContent = data.Plot || "No plot available.";
      } catch (err) {
        console.error("Error loading movie details:", err);
      }
    }

    // Load cast
    async function loadCast() {
      try {
        const tmdbRes = await fetch(`https://api.themoviedb.org/3/find/${imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
        const tmdbData = await tmdbRes.json();
        if (!tmdbData.movie_results || !tmdbData.movie_results.length) return;
        const movieId = tmdbData.movie_results[0].id;
        const creditsRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${TMDB_KEY}`);
        const creditsData = await creditsRes.json();
        const castGrid = document.getElementById("castGrid");
        castGrid.innerHTML = "";
        creditsData.cast.slice(0,6).forEach(actor => {
          if (!actor.name) return;
          const div = document.createElement("div");
          div.className = "actor-card";
          div.innerHTML = `
            <img src="${actor.profile_path ? 'https://image.tmdb.org/t/p/w200'+actor.profile_path : 'placeholder.jpg'}" alt="${actor.name}" />
            <p>${actor.name}</p>
          `;
          castGrid.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading cast:", err);
      }
    }

    // Load recommendations
    async function loadRecommendations() {
      try {
        const tmdbRes = await fetch(`https://api.themoviedb.org/3/find/${imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
        const tmdbData = await tmdbRes.json();
        if (!tmdbData.movie_results || !tmdbData.movie_results.length) return;
        const movieId = tmdbData.movie_results[0].id;
        const recRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/recommendations?api_key=${TMDB_KEY}`);
        const recData = await recRes.json();
        const recGrid = document.getElementById("recommendGrid");
        recGrid.innerHTML = "";
        recData.results.slice(0,6).forEach(rec => {
          if (!rec.title || !rec.id) return;
          const div = document.createElement("div");
          div.className = "movie-card";
          div.innerHTML = `
            <a href="movie.html?id=tt${rec.id}">
              <img src="${rec.poster_path ? 'https://image.tmdb.org/t/p/w200'+rec.poster_path : 'placeholder.jpg'}" alt="${rec.title}" />
              <h3>${rec.title}</h3>
            </a>
          `;
          recGrid.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading recommendations:", err);
      }
    }

    // Watchlist button
    const watchlistBtn = document.getElementById("watchlistBtn");
    watchlistBtn.addEventListener("click", () => {
      let watchlist = JSON.parse(localStorage.getItem("watchlist")) || [];
      if (watchlist.includes(imdbID)) {
        watchlist = watchlist.filter(id => id !== imdbID);
        watchlistBtn.textContent = "+ Add to Watchlist";
      } else {
        watchlist.push(imdbID);
        watchlistBtn.textContent = "✓ Added";
      }
      localStorage.setItem("watchlist", JSON.stringify(watchlist));
    });

    // ✅ Play button using movies.js
    const playBtn = document.getElementById("playBtn");
    playBtn.addEventListener("click", () => {
      const movieMap = window.movieMap;
      const movieSrc = movieMap[imdbID];

      if (movieSrc) {
        const player = document.getElementById("videoPlayer");
        const video = document.getElementById("movieVideo");

        video.src = movieSrc;
        player.style.display = "flex";

        if (player.requestFullscreen) {
          player.requestFullscreen();
        } else if (player.webkitRequestFullscreen) {
          player.webkitRequestFullscreen();
        } else if (player.msRequestFullscreen) {
          player.msRequestFullscreen();
        }

        video.play();
      } else {
        alert("Movie source not found. Please check movies.js.");
      }
    });

    // Exit fullscreen
    const exitBtn = document.getElementById("exitFullscreen");
    exitBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const player = document.getElementById("videoPlayer");
      const video = document.getElementById("movieVideo");

      video.pause();
      video.src = "";
      player.style.display = "none";

      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    });

    // Esc key exits video too
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const player = document.getElementById("videoPlayer");
        const video = document.getElementById("movieVideo");
        if (player.style.display === "flex") {
          video.pause();
          video.src = "";
          player.style.display = "none";
          if (document.exitFullscreen) document.exitFullscreen();
        }
      }
    });

    // Init
    loadMovieDetails();
    loadCast();
    loadRecommendations();
  </script>
</body>
</html>