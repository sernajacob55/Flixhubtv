<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Movie • FlixHubTV</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1 class="logo">FlixHubTV</h1>
    <nav>
      <button onclick="window.location.href='profiles.html'">Switch Profile</button>
      <button onclick="logout()">Logout</button>
      <button onclick="window.location.href='index.html'">Home</button>
    </nav>
  </header>

  <main class="movie-container">
    <div id="movie-details"></div>

    <section>
      <h2>Cast</h2>
      <div id="cast" class="cast-grid"></div>
    </section>

    <section>
      <h2>Recommended</h2>
      <div id="recommended" class="recommended-grid"></div>
    </section>
  </main>

  <script>
    const omdbKey = "ea7569d7";  // ✅ OMDb
    const tmdbKey = "a2942c822ee97bc0df2dba1a65cf2d0f"; // ✅ TMDb

    const urlParams = new URLSearchParams(window.location.search);
    const imdbID = urlParams.get("id");

    async function loadMovie() {
      const res = await fetch(`https://www.omdbapi.com/?i=${imdbID}&apikey=${omdbKey}&plot=full`);
      const movie = await res.json();

      if (movie.Response === "False") {
        document.getElementById("movie-details").innerHTML = `<p>Movie not found</p>`;
        return;
      }

      document.getElementById("movie-details").innerHTML = `
        <div class="movie-meta">
          <img src="${movie.Poster}" alt="${movie.Title}">
          <div>
            <h2>${movie.Title}</h2>
            <p><strong>Year:</strong> ${movie.Year} | <strong>Runtime:</strong> ${movie.Runtime} | <strong>Genre:</strong> ${movie.Genre}</p>
            <p>${movie.Plot}</p>
            <button onclick="playMovie('${imdbID}')">▶ Play</button>
            <button id="watchlist-btn" onclick="toggleWatchlist('${imdbID}', '${movie.Title}')">+ Add to Watchlist</button>
          </div>
        </div>
      `;

      loadCast(movie.Title);  // Use TMDb for actors
      loadRecommended(movie.Title); // Use TMDb recommendations
    }

    // TMDb cast lookup
    async function loadCast(title) {
      const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${tmdbKey}&query=${encodeURIComponent(title)}`);
      const data = await res.json();

      if (data.results.length > 0) {
        const movieId = data.results[0].id;
        const creditsRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${tmdbKey}`);
        const credits = await creditsRes.json();

        const castDiv = document.getElementById("cast");
        credits.cast.slice(0, 6).forEach(actor => {
          const img = actor.profile_path
            ? `https://image.tmdb.org/t/p/w200${actor.profile_path}`
            : "https://via.placeholder.com/100x150";

          castDiv.innerHTML += `
            <div class="cast-card">
              <img src="${img}" alt="${actor.name}">
              <p>${actor.name}</p>
            </div>
          `;
        });
      }
    }

    // TMDb recommended movies
    async function loadRecommended(title) {
      const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${tmdbKey}&query=${encodeURIComponent(title)}`);
      const data = await res.json();

      if (data.results.length > 0) {
        const movieId = data.results[0].id;
        const recRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/recommendations?api_key=${tmdbKey}`);
        const recData = await recRes.json();

        const recDiv = document.getElementById("recommended");
        recDiv.innerHTML = "";

        recData.results.slice(0, 6).forEach(rec => {
          const img = rec.poster_path
            ? `https://image.tmdb.org/t/p/w200${rec.poster_path}`
            : "https://via.placeholder.com/150";

          recDiv.innerHTML += `
            <div class="rec-card" onclick="window.location.href='movie.html?id=${rec.id}'>
              <img src="${img}" alt="${rec.title}">
              <p>${rec.title}</p>
            </div>
          `;
        });
      }
    }

    function playMovie(id) {
      alert("Play movie with ID: " + id);
    }

    function toggleWatchlist(id, title) {
      let watchlist = JSON.parse(localStorage.getItem("watchlist")) || [];
      const exists = watchlist.find(m => m.id === id);

      if (exists) {
        watchlist = watchlist.filter(m => m.id !== id);
        document.getElementById("watchlist-btn").innerText = "+ Add to Watchlist";
      } else {
        watchlist.push({ id, title });
        document.getElementById("watchlist-btn").innerText = "✔ Remove from Watchlist";
      }

      localStorage.setItem("watchlist", JSON.stringify(watchlist));
    }

    function logout() {
      localStorage.removeItem("currentProfile");
      window.location.href = "login.html";
    }

    loadMovie();
  </script>
</body>
</html>